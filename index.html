<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Pythagoras Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        rel="icon"
        type="image/png"
        href="https://pbs.twimg.com/profile_images/1934315850149908480/jIjeWYOq_400x400.jpg"
    />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        canvas {
            touch-action: none;
            display: block; /* remove default canvas margin */
        }
        /* Simple toggle switch styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5; /* indigo-600 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-50 text-gray-800 antialiased">

    <header class="bg-white shadow-md p-4 z-10">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
                Interactive 3D Pythagoras Explorer
            </h1>
            <p class="text-sm md:text-md text-indigo-600">
                Splitting the Cuboid
            </p>
        </div>
    </header>

    <main
        class="flex-grow flex flex-col lg:flex-row items-center justify-center p-4 md:p-8 space-y-4 lg:space-y-0 lg:space-x-8 overflow-hidden"
    >
        <div
            class="w-full lg:w-2/3 h-2/5 lg:h-full max-w-3xl bg-white rounded-2xl shadow-lg border border-gray-200 cursor-grab active:cursor-grabbing overflow-hidden"
        >
            <div id="canvas-container" class="w-full h-full"></div>
        </div>

        <div
            class="w-full lg:w-1/3 h-3/5 lg:h-auto max-w-md p-6 bg-white rounded-2xl shadow-lg border border-gray-200 overflow-y-auto"
        >
            <h2 class="text-xl font-semibold mb-2 text-center">
                Adjust Dimensions
            </h2>
            <p class="text-center text-gray-500 mb-4">
                Click any 2 corners to measure distance.
            </p>

            <div class="space-y-6">
                <div>
                    <label
                        for="sliderL"
                        class="flex justify-between items-center text-lg font-medium text-red-600"
                    >
                        <span>Length (l)</span>
                        <span
                            id="valueL"
                            class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-base font-semibold"
                            >12</span
                        >
                    </label>
                    <input
                        id="sliderL"
                        type="range"
                        min="1"
                        max="20"
                        value="12"
                        class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                </div>
                <div>
                    <label
                        for="sliderW"
                        class="flex justify-between items-center text-lg font-medium text-green-600"
                    >
                        <span>Width (w)</span>
                        <span
                            id="valueW"
                            class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-base font-semibold"
                            >6</span
                        >
                    </label>
                    <input
                        id="sliderW"
                        type="range"
                        min="1"
                        max="20"
                        value="6"
                        class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                </div>
                <div>
                    <label
                        for="sliderH"
                        class="flex justify-between items-center text-lg font-medium text-blue-600"
                    >
                        <span>Height (h)</span>
                        <span
                            id="valueH"
                            class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-base font-semibold"
                            >9</span
                        >
                    </label>
                    <input
                        id="sliderH"
                        type="range"
                        min="1"
                        max="20"
                        value="9"
                        class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                    />
                </div>
            </div>

            <div class="space-y-3 mt-8">
                <div class="flex items-center justify-between">
                    <label
                        for="showBaseTriangleToggle"
                        class="text-lg font-medium text-gray-700"
                        >Show Base Triangle</label
                    >
                    <div
                        class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"
                    >
                        <input
                            type="checkbox"
                            name="toggle"
                            id="showBaseTriangleToggle"
                            class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"
                        />
                        <label
                            for="showBaseTriangleToggle"
                            class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"
                        ></label>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label
                        for="showSpaceTriangleToggle"
                        class="text-lg font-medium text-gray-700"
                        >Show Space Triangle</label
                    >
                    <div
                        class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"
                    >
                        <input
                            type="checkbox"
                            name="toggle"
                            id="showSpaceTriangleToggle"
                            class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"
                        />
                        <label
                            for="showSpaceTriangleToggle"
                            class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"
                        ></label>
                    </div>
                </div>
                 <div class="flex items-center justify-between">
                    <label
                        for="showVerticesToggle"
                        class="text-lg font-medium text-gray-700"
                        >Show Corners</label
                    >
                    <div
                        class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"
                    >
                        <input
                            type="checkbox"
                            name="toggle"
                            id="showVerticesToggle"
                            class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"
                            checked
                        />
                        <label
                            for="showVerticesToggle"
                            class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"
                        ></label>
                    </div>
                </div>
            </div>

            <!-- Measurement Result Display -->
            <div
                id="measurement-container"
                class="text-left bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg mt-6 space-y-1 hidden"
            >
                <h3 class="font-semibold text-gray-800">
                    Measured Distance
                </h3>
                <p
                    id="measurement-result"
                    class="font-mono text-gray-600 text-lg"
                ></p>
            </div>

            <div
                class="text-left bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg mt-6 space-y-4"
            >
                <div>
                    <h3 class="font-semibold text-gray-800">
                        Step 1: Find Base Diagonal (f)
                    </h3>
                    <p id="formulaBase" class="font-mono text-gray-600">
                        f² = l² + w²
                    </p>
                    <div class="mt-2">
                        <button
                            id="resultBase"
                            class="w-full text-left font-mono text-indigo-700 bg-indigo-100 p-2 rounded-md hover:bg-indigo-200 transition disabled:opacity-70 disabled:cursor-not-allowed"
                        >
                            Reveal Base Diagonal (f)
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-800">
                        Step 2: Find Space Diagonal (d)
                    </h3>
                    <p id="formulaSpace" class="font-mono text-gray-600">
                        d² = f² + h²
                    </p>
                    <div class="mt-2">
                        <button
                            id="resultSpace"
                            class="w-full text-left font-mono text-indigo-700 bg-indigo-100 p-2 rounded-md hover:bg-indigo-200 transition disabled:opacity-70 disabled:cursor-not-allowed"
                        >
                            Reveal Space Diagonal (d)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer
        class="bg-white text-center text-sm text-gray-500 p-4 border-t border-gray-200"
    >
        <p>
            &copy; <span id="year"></span> | A project by
            <a
                href="https://twitter.com/alvlmathteacher"
                target="_blank"
                rel="noopener noreferrer"
                class="text-indigo-600 hover:underline"
                >alvlmathteacher</a
            >
        </p>
    </footer>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from "three";
        import { OrbitControls } from "three/addons/controls/OrbitControls.js";

        // --- DOM Elements ---
        const container = document.getElementById("canvas-container");
        const sliders = {
            l: document.getElementById("sliderL"),
            w: document.getElementById("sliderW"),
            h: document.getElementById("sliderH"),
        };
        const values = {
            l: document.getElementById("valueL"),
            w: document.getElementById("valueW"),
            h: document.getElementById("valueH"),
        };
        const showBaseTriangleToggle = document.getElementById(
            "showBaseTriangleToggle"
        );
        const showSpaceTriangleToggle = document.getElementById(
            "showSpaceTriangleToggle"
        );
        const showVerticesToggle = document.getElementById("showVerticesToggle");
        const formulaBase = document.getElementById("formulaBase");
        const resultBase = document.getElementById("resultBase");
        const formulaSpace = document.getElementById("formulaSpace");
        const resultSpace = document.getElementById("resultSpace");
        const measurementContainer = document.getElementById(
            "measurement-container"
        );
        const measurementResult =
            document.getElementById("measurement-result");
        document.getElementById("year").textContent =
            new Date().getFullYear();

        // --- State ---
        let dims = {
            l: +sliders.l.value,
            w: +sliders.w.value,
            h: +sliders.h.value,
        };
        let showBaseTriangle = showBaseTriangleToggle.checked;
        let showSpaceTriangle = showSpaceTriangleToggle.checked;
        let showVertices = showVerticesToggle.checked;
        let selectedVertices = [];

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        const camera = new THREE.PerspectiveCamera(
            75,
            container.clientWidth / container.clientHeight,
            0.1,
            1000
        );
        camera.position.set(15, 15, 15);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        container.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0xffffff, 1.0));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(10, 20, 5);
        scene.add(directionalLight);

        // --- Raycasting ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- Object Creation ---
        let baseTriangle, spaceTriangle, verticesGroup, measuredLine, labelsGroup;
        const vertexDefaultMaterial = new THREE.MeshBasicMaterial({
            color: 0x555555,
        });
        const vertexSelectedMaterial = new THREE.MeshBasicMaterial({
            color: 0xffd700,
        });
        const yellowMaterial = new THREE.MeshBasicMaterial({
            color: 0xffd700,
        });

        // Helper function to create text sprites for labels
        function createTextSprite(text, color) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const fontSize = 96;
            context.font = `Bold ${fontSize}px Inter, sans-serif`;
            
            const metrics = context.measureText(text);
            const textWidth = metrics.width;

            canvas.width = textWidth;
            canvas.height = fontSize * 1.2;
            
            context.font = `Bold ${fontSize}px Inter, sans-serif`;
            context.fillStyle = color;
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, canvas.width / 2, canvas.height / 2);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(spriteMaterial);
            
            const aspect = canvas.width / canvas.height;
            sprite.scale.set(aspect * 5, 5, 1);

            return sprite;
        }

        function createGeometry() {
            // Clean up previous scene objects
            scene.children
                .filter(
                    (obj) => obj.isMesh || obj.isLineSegments || obj.isGroup
                )
                .forEach((obj) => scene.remove(obj));

            // Define 8 vertices of the cuboid
            const p = [
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(dims.l, 0, 0),
                new THREE.Vector3(dims.l, 0, dims.w),
                new THREE.Vector3(0, 0, dims.w),
                new THREE.Vector3(0, dims.h, 0),
                new THREE.Vector3(dims.l, dims.h, 0),
                new THREE.Vector3(dims.l, dims.h, dims.w),
                new THREE.Vector3(0, dims.h, dims.w),
            ];

            // Create colored edges (as tubes)
            const edges = new THREE.Group();
            const redMaterial = new THREE.MeshBasicMaterial({
                color: 0xef4444,
            });
            const greenMaterial = new THREE.MeshBasicMaterial({
                color: 0x22c55e,
            });
            const blueMaterial = new THREE.MeshBasicMaterial({
                color: 0x3b82f6,
            });

            const addEdge = (p1, p2, material) => {
                const path = new THREE.LineCurve3(p1, p2);
                const tubeGeometry = new THREE.TubeGeometry(
                    path,
                    1,
                    0.15,
                    8,
                    false
                );
                const edgeMesh = new THREE.Mesh(tubeGeometry, material);
                edges.add(edgeMesh);
            };
            // Length edges (red)
            addEdge(p[0], p[1], redMaterial);
            addEdge(p[3], p[2], redMaterial);
            addEdge(p[4], p[5], redMaterial);
            addEdge(p[7], p[6], redMaterial);
            // Width edges (green)
            addEdge(p[0], p[3], greenMaterial);
            addEdge(p[1], p[2], greenMaterial);
            addEdge(p[4], p[7], greenMaterial);
            addEdge(p[5], p[6], greenMaterial);
            // Height edges (blue)
            addEdge(p[0], p[4], blueMaterial);
            addEdge(p[1], p[5], blueMaterial);
            addEdge(p[2], p[6], blueMaterial);
            addEdge(p[3], p[7], blueMaterial);
            scene.add(edges);

            // Create clickable vertices (spheres)
            verticesGroup = new THREE.Group();
            p.forEach((pos) => {
                const sphereGeom = new THREE.SphereGeometry(0.54, 16, 16);
                const vertexSphere = new THREE.Mesh(
                    sphereGeom,
                    vertexDefaultMaterial.clone()
                );
                vertexSphere.position.copy(pos);
                verticesGroup.add(vertexSphere);
            });
            if (showVertices) {
                scene.add(verticesGroup);
            }

            // Create text labels
            labelsGroup = new THREE.Group();
            const labelL = createTextSprite(dims.l.toString(), '#ef4444');
            labelL.position.set(dims.l / 2, -1.5, 0); 
            labelsGroup.add(labelL);

            const labelW = createTextSprite(dims.w.toString(), '#22c55e');
            labelW.position.set(dims.l, -1.5, dims.w / 2); 
            labelsGroup.add(labelW);

            const labelH = createTextSprite(dims.h.toString(), '#3b82f6');
            labelH.position.set(-1.5, dims.h / 2, 0);
            labelsGroup.add(labelH);
            
            scene.add(labelsGroup);

            // Center all objects
            const centerOffset = new THREE.Vector3(
                -dims.l / 2,
                -dims.h / 2,
                -dims.w / 2
            );
            [edges, verticesGroup, labelsGroup].forEach((obj) =>
                obj.position.copy(centerOffset)
            );

            // Triangles (initially invisible)
            const basePoints = [p[0], p[1], p[2]];
            baseTriangle = new THREE.Mesh(
                new THREE.BufferGeometry().setFromPoints(basePoints),
                new THREE.MeshBasicMaterial({
                    color: 0x10b891,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0,
                })
            );
            baseTriangle.position.copy(centerOffset);
            scene.add(baseTriangle);

            const spacePoints = [p[0], p[2], p[6]];
            spaceTriangle = new THREE.Mesh(
                new THREE.BufferGeometry().setFromPoints(spacePoints),
                new THREE.MeshBasicMaterial({
                    color: 0x3b82f6,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0,
                })
            );
            spaceTriangle.position.copy(centerOffset);
            scene.add(spaceTriangle);

            clearSelection();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function updateUI() {
            dims = {
                l: +sliders.l.value,
                w: +sliders.w.value,
                h: +sliders.h.value,
            };
            Object.keys(values).forEach(
                (key) => (values[key].textContent = dims[key])
            );

            createGeometry();

            // Reset reveal buttons
            formulaBase.innerHTML = `f² = <span class="text-red-500">${dims.l}²</span> + <span class="text-green-500">${dims.w}²</span>`;
            resultBase.textContent = "Reveal Base Diagonal (f)";
            resultBase.disabled = false;

            formulaSpace.innerHTML = `d² = <span class="text-yellow-500">f²</span> + <span class="text-blue-500">${dims.h}²</span>`;
            resultSpace.textContent = "Reveal Space Diagonal (d)";
            resultSpace.disabled = true;

            // Re-apply triangle visibility based on toggle state
            showBaseTriangle = showBaseTriangleToggle.checked;
            showSpaceTriangle = showSpaceTriangleToggle.checked;
            if (baseTriangle) {
                baseTriangle.material.opacity = showBaseTriangle ? 0.8 : 0;
            }
            if (spaceTriangle) {
                spaceTriangle.material.opacity = showSpaceTriangle ? 0.8 : 0;
            }
        }

        function handleResize() {
            const { clientWidth: width, clientHeight: height } = container;
            renderer.setSize(width, height);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        }

        function clearSelection(resetResult = true) {
            selectedVertices.forEach(
                (v) => (v.material = vertexDefaultMaterial)
            );
            selectedVertices = [];
            if (measuredLine) scene.remove(measuredLine);
            if (resetResult) measurementContainer.classList.add("hidden");
        }

        function onCanvasClick(event) {
            if (!showVertices) return; // Ignore clicks if vertices are hidden
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(
                verticesGroup.children
            );

            if (intersects.length > 0) {
                const clickedVertex = intersects[0].object;

                if (selectedVertices.includes(clickedVertex)) {
                    // Deselect
                    clickedVertex.material = vertexDefaultMaterial;
                    selectedVertices = selectedVertices.filter(
                        (v) => v !== clickedVertex
                    );
                    if (measuredLine) scene.remove(measuredLine);
                } else if (selectedVertices.length < 2) {
                    // Select
                    clickedVertex.material = vertexSelectedMaterial;
                    selectedVertices.push(clickedVertex);
                }

                if (selectedVertices.length === 2) {
                    const [v1, v2] = selectedVertices;
                    const distance = v1.position.distanceTo(v2.position);
                    measurementResult.textContent = `${distance.toFixed(
                        2
                    )} units`;
                    measurementContainer.classList.remove("hidden");

                    // Draw line as a tube
                    if (measuredLine) scene.remove(measuredLine);
                    const path = new THREE.LineCurve3(
                        v1.position,
                        v2.position
                    );
                    const tubeGeometry = new THREE.TubeGeometry(
                        path,
                        1,
                        0.15,
                        8,
                        false
                    );
                    measuredLine = new THREE.Mesh(
                        tubeGeometry,
                        yellowMaterial
                    );
                    measuredLine.position.copy(verticesGroup.position); // Align with group offset
                    scene.add(measuredLine);

                    setTimeout(() => clearSelection(false), 2000);
                }
            }
        }

        // --- Event Listeners ---
        Object.values(sliders).forEach((slider) =>
            slider.addEventListener("input", updateUI)
        );
        renderer.domElement.addEventListener("click", onCanvasClick);

        showBaseTriangleToggle.addEventListener("change", () => {
            showBaseTriangle = showBaseTriangleToggle.checked;
            if (showBaseTriangle) clearSelection();
            if (baseTriangle) {
                baseTriangle.material.opacity = showBaseTriangle ? 0.8 : 0;
            }
        });

        showSpaceTriangleToggle.addEventListener("change", () => {
            showSpaceTriangle = showSpaceTriangleToggle.checked;
            if (showSpaceTriangle) clearSelection();
            if (spaceTriangle) {
                spaceTriangle.material.opacity = showSpaceTriangle ? 0.8 : 0;
            }
        });

        showVerticesToggle.addEventListener("change", () => {
            showVertices = showVerticesToggle.checked;
            if (verticesGroup) {
                verticesGroup.visible = showVertices;
            }
        });

        resultBase.addEventListener("click", () => {
            const f = Math.sqrt(dims.l * dims.l + dims.w * dims.w);
            resultBase.textContent = `f = ${f.toFixed(2)}`;
            resultBase.disabled = true;

            formulaSpace.innerHTML = `d² = <span class="text-yellow-500">${f.toFixed(
                2
            )}²</span> + <span class="text-blue-500">${dims.h}²</span>`;
            resultSpace.disabled = false;
        });

        resultSpace.addEventListener("click", () => {
            const f = Math.sqrt(dims.l * dims.l + dims.w * dims.w);
            const d = Math.sqrt(f * f + dims.h * dims.h);
            resultSpace.textContent = `d = ${d.toFixed(2)}`;
            resultSpace.disabled = true;
        });

        window.addEventListener("resize", handleResize);

        // --- Initial Call ---
        updateUI();
        handleResize();
        animate();
    </script>
</body>
</html>

